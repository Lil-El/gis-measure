import{W as P,eY as A,qp as bt,qq as $t,ca as Se,c7 as le,iJ as f,mY as Tt,ln as Fe,mS as Ie,bn as Oe,bt as Ue,fM as z,Y as I,lf as k,Z as Ot,o8 as Xe,g8 as N,gE as K,qr as qe,gq as Dt,m as ne,t as De,l as ee,g as v,w as x,aJ as At,a0 as et,e as d,y as u,a as V,at as U,om as xt,be as j,iU as Me,bf as de,fI as se,qs as Z,cr as tt,qt as Rt,ld as it,gd as nt,$ as st,gJ as R,iG as at,lc as we,lb as Pe,ll as Be,qu as zt,cb as Ht,aP as Ce,cm as kt,qv as Lt,cC as Et,h as ue,V as Ae,qw as Vt,A as xe,qx as Gt,qy as Ft,qz as It,a2 as Ut,ls as ce,iP as O,U as be,f2 as qt,n8 as Bt,gF as je,f as Re,qA as $e,iT as J,l8 as jt,i8 as Nt,G as Wt,cP as Ne,qB as Jt,gv as Yt,lh as Kt,ly as Zt,gQ as Qt,lB as Xt,qC as ot,k3 as ei,k4 as ti,lr as W,qD as ii,qE as ni,qF as si,B as We,u as Je}from"./index-DXZ_271k.js";import{s as ai}from"./AnalysisView3D-Uc3Bi7aL.js";import{t as g,r as oi,u as ri}from"./LengthDimension-BLtzdz1a.js";import{f as rt,e as li,h as di}from"./quantityFormatUtils-COr84EAs.js";import{f as q,g as ui}from"./Segment-CaA1BVzz.js";import{z as ci,x as pi}from"./euclideanLengthMeasurementUtils-D-Iu9aOa.js";import{i as fe,u as mi}from"./analysisThemeUtils-B98eyn3k.js";import{T as hi,$ as lt,U as dt,e as Q,R as fi,N as ze,L as gi,D as _i}from"./ShadedColorMaterial.glsl-CvwJ1yiF.js";import{A as He,F as vi,H as ut,n as yi}from"./Factory-Be4TK12C.js";import{d as ae,R as ke,U as Si}from"./InteractiveToolBase-CHfbHJ5a.js";import{t as Mi,O as wi,_ as Pi}from"./VerticesVisualElement-BOOvz3c8.js";import{u as G,b as Ci,r as bi,a as $i}from"./LineVisualElement-BLsBgjJE.js";import{c as Ti}from"./ImageMaterial.glsl-kWfAYtdM.js";import{_ as Oi,p as Di,w as Ai}from"./EditGeometryOperations-CoUd7xYn.js";import{e as xi}from"./SnappingContext-CAahT2yd.js";import{p as Ri,f as zi}from"./SnappingOperation-DE4LrNgA.js";import{a as Hi,b as ki,v as Li,l as Ei}from"./analysisViewUtils-BhYAco9V.js";import"./unitFormatUtils-BYiGmLdC.js";import"./TextOverlayItem-C67ZJJnM.js";import"./measurementUtils-Dvi97IFc.js";import"./colorUtils-DA8Qa9eB.js";import"./drawUtils-OYVnrxqm.js";import"./RightAngleQuadVisualElement-C0Z3_PNN.js";import"./VisualElementResources-BCCQRmzo.js";import"./Laserlines.glsl-tQTQbEzF.js";import"./PointSnappingHint-BROKmB1u.js";import"./dehydratedFeatureComparison-CuMnCfoB.js";function Vi(e,t,i){if(e==null)return null;const n=e.dimensionSegment.startRenderSpace,s=e.dimensionSegment.endRenderSpace,a=pi(n,s,e.spatialReference);if(a==null)return null;const o=t===g.Vertical?bt(a.value,a.unit,i):$t(a.value,a.unit,i);return rt(a,o)}function pe(e){const{elevationAlignedStartPoint:t,elevationAlignedEndPoint:i,dimension:{offset:n,measureType:s,orientation:a}}=e;return{elevationAlignedStartPoint:t,elevationAlignedEndPoint:i,offset:n,measureType:s,orientation:a}}function me({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,offset:i,measureType:n,orientation:s},a,o=null){if(e==null||t==null)return null;const r=pt(o!=null?o.directSegment:new q,{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t},a),l=o!=null?o.primaryOffsetAxis:P();ge(l,{measureType:n,elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,directSegment:r,orientation:s,renderCoordsHelper:a});const c=o!=null?o.dimensionSegment:new q;return Le({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t})&&n===g.Vertical?(A(c.startRenderSpace,r.startRenderSpace),A(c.endRenderSpace,r.endRenderSpace)):mt(c,{offsetAxis:l,offset:i,relativeToSegment:r,renderCoordsHelper:a}),{directSegment:r,dimensionSegment:c,primaryOffsetAxis:l,spatialReference:a.spatialReference}}function Ye(e,t,i,n){return t===te.Start?(A(e.startRenderSpace,i.startRenderSpace),A(e.endRenderSpace,n.startRenderSpace)):(A(e.startRenderSpace,i.endRenderSpace),A(e.endRenderSpace,n.endRenderSpace)),e}var te;function Gi(e,t,i,n){le(e.startRenderSpace,t.startRenderSpace,i,n),le(e.endRenderSpace,t.endRenderSpace,i,n)}function ct(e,t,i,n){switch(t){case g.Direct:return pt(e,i,n);case g.Horizontal:case g.Vertical:{const{elevationAlignedStartPoint:s,elevationAlignedEndPoint:a,dimension:o,geometry:r}=i;let l;o.measureType===g.Direct?(l=Fi(r,n)===s.z>a.z,t===g.Horizontal&&(l=!l)):l=!Ii(r);const[c,p]=l?[s,a]:[a,s],m=K(p,Ui);return t===g.Horizontal?m.z=c.z:(m.x=c.x,m.y=c.y),n.toRenderCoords(c,e.startRenderSpace),n.toRenderCoords(m,e.endRenderSpace),e}}}function pt(e,t,i){return i.toRenderCoords(t.elevationAlignedStartPoint,e.startRenderSpace),i.toRenderCoords(t.elevationAlignedEndPoint,e.endRenderSpace),e}function Fi(e,t){const i=e.directSegment.eval(.5,f.get()),n=t.worldUpAtPosition(i,f.get()),s=e.dimensionSegment.eval(.5,f.get()),a=z(f.get(),s,i);return!Xe(a,N)&&k(a,n)>0}function Ii(e){const{startRenderSpace:t,endRenderSpace:i}=e.dimensionSegment,{startRenderSpace:n,endRenderSpace:s}=e.directSegment;return qe(n,t)<qe(s,i)}(function(e){e[e.Start=0]="Start",e[e.End=1]="End"})(te||(te={}));const Ui=Dt(0,0,0,null);function qi(e,t,i,n){const{directSegment:s}=i,a=ge(f.get(),{measureType:t,directSegment:s,renderCoordsHelper:n}),o=mt(Bi,{offsetAxis:a,offset:0,relativeToSegment:s,renderCoordsHelper:n}).eval(.5,f.get()),r=z(f.get(),e,o);return k(r,a)*n.unitInMeters}const Bi=new q;function ge(e,t){const{measureType:i,elevationAlignedStartPoint:n,elevationAlignedEndPoint:s,directSegment:{startRenderSpace:a,endRenderSpace:o},directSegment:r,renderCoordsHelper:l}=t,c=r.eval(.5,f.get()),p=l.worldUpAtPosition(c,f.get()),m=l.worldBasisAtPosition(c,Tt.Y,f.get());switch(i){case g.Horizontal:A(e,p);break;case g.Vertical:k(a,p)<k(o,p)?z(e,o,a):z(e,a,o),I(e,e,p),I(e,e,p);break;case g.Direct:{const h=t.orientation??0;if(Le({elevationAlignedStartPoint:n,elevationAlignedEndPoint:s}))Fe(oe,-Ie(h),p),Ue(e,m,oe);else{const S=z(f.get(),o,a),M=I(f.get(),S,p);I(M,M,S),Fe(oe,Ie(h),S),Ue(e,M,oe)}break}}return Xe(e,N)?A(e,m):Ot(e,e)}const oe=Oe();function Le({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t}){return e!=null&&t!=null&&e.x===t.x&&e.y===t.y}function mt(e,t){const{offsetAxis:i,offset:n,relativeToSegment:{startRenderSpace:s,endRenderSpace:a},relativeToSegment:o,renderCoordsHelper:r}=t,l=n/r.unitInMeters,[c,p]=ji(s,a,i,l);return le(e.startRenderSpace,o.startRenderSpace,i,c),le(e.endRenderSpace,o.endRenderSpace,i,p),e}function ji(e,t,i,n=0){const s=k(t,i),a=k(e,i),o=Math.abs(s-a)+n;return s>a?[o,n]:[n,o]}function _e(e,t,i){const n=t.directSegment.eval(.5,f.get());return i.worldUpAtPosition(n,e)}function Ee(e,t){const{startRenderSpace:i,endRenderSpace:n}=t.directSegment;return z(e,n,i)}function Ve(e,t,i={invert:!1}){const{startRenderSpace:n,endRenderSpace:s}=t.dimensionSegment;return i.invert?z(e,n,s):z(e,s,n)}function Te(e,t){const i=e.directSegment.eval(.5,f.get());return t.headingAtPosition(i,e.primaryOffsetAxis)}function Ni(e,t){return Se(Ve(Wi,e))/t**2}const Wi=P();function ht(e){const{elevationAlignedStartPoint:t,elevationAlignedEndPoint:i}=e;if(t==null||i==null)return!1;const n=ci(t,i);return n!=null&&rt(n,"meters").value>ft}const ft=1e5;function ie(e){return e.geometry!=null}let F=class extends ne{constructor(t){super(t),this._handles=new De}initialize(){const{computations:t}=this.analysisViewData;for(const i of t)this._addComputation(i);this.addHandles(t.on("change",({added:i,removed:n})=>{for(const s of n)this._removeComputation(s);for(const s of i)this._addComputation(s)}))}destroy(){this._handles=ee(this._handles)}get analysis(){return this.analysisViewData.analysis}get _defaultUnit(){return li(this.view)}_addComputation(t){this._handles.has(t)||this._handles.add(v(()=>pe(t),i=>{const{measureType:n}=i;if(ht(i)&&n!==g.Direct){const a=Math.round(At(ft,"meters","kilometers"));return et.getLogger(this).warnOnce(`A ${n} dimension in the analysis (id: '${this.analysis.id}') will not display, because only direct dimensions can measure lengths greater than ${a} km. Update the measureType of the affected dimension to "direct" to display it.`),void(t.geometry=null)}const s=me(i,this.view.renderCoordsHelper,t.geometry);t.geometry=s,t.result.length=Vi(s,n,this._defaultUnit)},x),t)}_removeComputation(t){this._handles.remove(t)}};d([u({constructOnly:!0})],F.prototype,"analysisViewData",void 0),d([u({constructOnly:!0})],F.prototype,"view",void 0),d([u()],F.prototype,"analysis",null),d([u()],F.prototype,"_defaultUnit",null),F=d([V("esri.views.3d.analysis.Dimension.support.DimensionController")],F);let Ji=class{constructor(){this.color=fe(.5),this.radius=5}};class Yi{constructor(){this.color=new U([127,127,127,.5]),this.radius=5}}let Ki=class{constructor(){this.lineSizeFraction=.8}};class Zi{constructor(){this.color=fe(.5),this.linePaddingPx=4,this.focusedLinePaddingPx=6,this.lengthFraction=.5,this.minLengthMeters=.1}}let Qi=class{constructor(){this.calloutOffsetPx=18,this.calloutWidth=2,this.discScale=.3,this.focusMultiplier=2,this.color=fe(.5),this.contrastColor=mi()}},Xi=class{constructor(){this.lineSizeFraction=.25}},en=class{constructor(){this.marginPx=20,this.minScreenLengthFontSizeFactor=5}},tn=class{constructor(){this.color=fe(.5)}};class nn{constructor(){this.pointManipulators=new Ji,this.offsetManipulator=new Zi,this.orientationManipulator=new Qi,this.markers=new Ki,this.labels=new en,this.offsetLine=new Xi,this.constraint=new tn,this.constraintThresholdPx=10,this.initialOffsetPx=50,this.orientationSnapThresholdDegrees=5,this.disabledPointIndicator=new Yi,this.smallScreenLengthLineSizeFactor=2,this.pointerMoveTimeoutMs=2500}}let _=new nn;class sn{constructor(t){this.start=t.start,this.end=t.end,this.offset=t.offset,this.heading=t.heading,this.rotation=t.rotation,this.direct=t.direct,this.horizontal=t.horizontal,this.vertical=t.vertical}manipulatorName(t){return Object.keys(this).find(i=>this.hasOwnProperty(i)&&t===this[i])}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(t){for(const i of oi)t(this.manipulatorForMeasureType(i),i)}manipulatorForMeasureType(t){switch(t){case g.Direct:return this.direct;case g.Horizontal:return this.horizontal;case g.Vertical:return this.vertical}}}function an(e,t){const i=hi(e,U.toUnitRGBA(_.pointManipulators.color),H);return i.available=!1,i.grabCursor="crosshair",i.radius=_.pointManipulators.radius,i.metadata=t.metadata,i.collisionPriority=1,i}function on(e,t){const i=[de(-.5,0,0),de(.5,0,0)],{lengthFraction:n}=_.offsetManipulator,s=Me(t.unfocusedMaterial,i.map(o=>se(P(),o,n))),a=s.instantiate({material:t.focusedMaterial});return new lt({view:e,renderObjects:[new Q(s,Z.Unfocused|Z.Selected|H),new Q(a,Z.Focused|H)],collisionType:{type:"line",paths:[i]},radius:Ge(t.lineSizePt)/2,metadata:t.metadata,available:!1,...dt})}function gt(e,{lineSizePt:t,material:i}){const{calloutOffsetPx:n,calloutWidth:s,discScale:a,focusMultiplier:o,color:r}=_.orientationManipulator;return{calloutLength:.25*zt*_.markers.lineSizeFraction*R(t)+n,calloutColor:U.toUnitRGBA(r),calloutWidth:s,customStateMask:H,discScale:a,focusMultiplier:o,material:i,metadata:e}}function Ke(e,t){return fi(e,gt(t.metadata,t))}function Ze(e,t){gi(e,gt(e.metadata,t))}function rn(e,t){const i=[de(-.5,0,0),de(.5,0,0)],{lengthFraction:n}=_.offsetManipulator,s=Me(t.thinOffsetManipulatorMaterial,i),a=Me(t.unfocusedMaterial,i.map(r=>se(P(),r,n))),o=a.instantiate({material:t.focusedMaterial});return new lt({view:e,renderObjects:[new Q(a,Z.Unfocused|H),new Q(o,Z.Focused|H),new Q(s,H)],collisionType:{type:"line",paths:[i]},radius:Ge(t.lineSizePt)/2,available:!1,metadata:t.metadata,...dt})}function ln(e,{isStart:t,createSnappingPipelineStep:i,dimension:n,onUpdate:s,view:a}){const o=t?"startPoint":"endPoint";return[ae(e,(l,c,p,m)=>{const h=He(l),{snappingStep:S,cancelSnapping:M}=i(m);p=p.next(h).next(ke(n,[o,"measureType","orientation"])).next(M),c.next(h).next(vi(a)).next(...S).next(b=>{const y=K(b.mapEnd,new j);s(o==="startPoint"?{startPoint:y}:{endPoint:y})})})]}function dn(e,{computation:t,view:i}){return[ae(e,(n,s,a)=>{if(!ie(t)||!n.selected)return;const{geometry:o,dimension:r}=t,l=He(n);s.next(l).next(vt(i,r,o.dimensionSegment,o.primaryOffsetAxis)),a.next(l).next(ke(r,["offset"]))})]}function un(e,{computation:t,view:i}){return[ae(e,(n,s,a)=>{_t({cancel:a,computation:t,settingHeading:!0,steps:s,view:i})})]}function cn(e,{computation:t,view:i}){return[ae(e,(n,s,a)=>{_t({cancel:a,computation:t,settingHeading:!1,steps:s,view:i})}),e.events.on("immediate-click",n=>{pn(n,t,i)})]}function pn(e,t,i){const{dimension:n,geometry:s}=t;if(n.orientation===90||n.orientation===270)return n.orientation=0,void e.stopPropagation();if(s==null)return;const{renderCoordsHelper:a}=i,o=me({...pe(t),orientation:90},a),r=me({...pe(t),orientation:270},a);if(o==null||r==null)return;const l=Te(o,a),c=Te(r,a),p=yt(s,i),m=Ce.shortestSignedDiff(p,l),h=Ce.shortestSignedDiff(p,c);n.orientation=Math.abs(m)<Math.abs(h)?90:270,e.stopPropagation()}function _t(e){const{cancel:t,computation:i,settingHeading:n,steps:s,view:a}=e;if(!ie(i))return;const{renderCoordsHelper:o}=a,{dimension:r,geometry:l}=i,c=P(),p=Mt(P(),l,l.directSegment,o),m=wt(f.get(),{forHeading:n,geometry:l,renderCoordsHelper:o}),h=we(p,m,Pe()),S=n?r.orientation??Te(l,a.renderCoordsHelper):r.orientation??0;s.next(ut(a,h)).next(M=>{M.action==="start"&&A(c,M.renderStart);const b=Ht(h),y=_i(c,M.renderEnd,p,b);let L=S-kt(y);n||(L=mn(L)),r.orientation=L}),t.next(ke(r,["orientation"]))}function mn(e){const t=Ce.normalize(e)%90;return t<_.orientationSnapThresholdDegrees?e-t:90-t<_.orientationSnapThresholdDegrees?e+(90-t):e}function hn(e,{computation:t,manipulatorMeasureType:i,view:n}){let s=g.Direct,a=0,o=0;return[e.events.on("grab-changed",r=>{if(r.action!=="start"||!ie(t))return;const{dimension:l,geometry:c}=t;s=l.measureType,a=l.offset,o=l.orientation;const p=A(f.get(),e.renderLocation);l.measureType=i,l.offset=qi(p,i,c,n.renderCoordsHelper),l.orientation=0}),ae(e,(r,l,c)=>{if(!ie(t))return;const{geometry:p,dimension:m}=t,{renderCoordsHelper:h}=n,S=ct(Pt,i,t,h),M=ge(f.get(),{measureType:i,directSegment:p.directSegment,renderCoordsHelper:h}),b=He(r);l.next(b).next(vt(n,m,S,M)),c.next(b).next(y=>(m.measureType=s,m.offset=a,m.orientation=o,y))})]}function vt(e,t,i,n){const s=at(f.get(),i.endRenderSpace,i.startRenderSpace);I(s,s,n);const a=we(i.startRenderSpace,s,Pe()),o=we(i.startRenderSpace,n,Pe()),r=t.offset;let l,c=0;const p=new Si;return p.next(ut(e,a)).next(m=>{m.action==="start"&&(c=Be(o,m.renderStart));const h=(Be(o,m.renderEnd)-c)*e.renderCoordsHelper.unitInMeters;t.offset=r+h,l=m}),m=>(p.execute(m),l)}function yt(e,t){const{directSegment:i}=e,{renderCoordsHelper:n}=t,s=_e(f.get(),e,n),a=Ee(f.get(),e),o=I(f.get(),a,s),{viewForward:r}=t.state.camera;k(o,r)>0&&se(o,o,-1);const l=i.eval(.5,f.get());return n.headingAtPosition(l,o)}function fn(e,t,i){const{dimensionSegment:n,primaryOffsetAxis:s}=t,a=Ve(X,t),o=tt(a,N)?Rt(he):ze(a,s,N,he),r=Math.max(it(a),_.offsetManipulator.minLengthMeters/i.unitInMeters);nt(o,o,st(X,r,r,r)),e.modelTransform=o,e.renderLocation=n.eval(.5,X)}function gn(e,t,i){St(e,t,i,{forHeading:!0})}function _n(e,t,i){St(e,t,i,{forHeading:!1})}function St(e,t,i,{forHeading:n}){const{dimension:s,geometry:a}=t,{primaryOffsetAxis:o}=a,r=se(vn,o,s.offset>=0?1:-1),l=wt(yn,{forHeading:n,geometry:a,renderCoordsHelper:i});I(l,l,r);const c=ze(r,l,N,he);e.modelTransform=c,e.renderLocation=Mt(X,a,a.dimensionSegment,i)}const vn=P(),yn=P();function Sn(e,t,i,n){const{geometry:s}=t,a=ct(Pt,i,t,n),o=ge(X,{measureType:i,directSegment:s.directSegment,renderCoordsHelper:n}),r=z(ve,a.endRenderSpace,a.startRenderSpace),l=ze(r,o,N,he),c=it(r);nt(l,l,st(ve,c,c,c)),e.modelTransform=l,e.renderLocation=a.eval(.5,ve)}function Mt(e,t,i,n){const{startRenderSpace:s,endRenderSpace:a}=i,o=Mn(t,n)?s:a;return A(e,o)}function wt(e,{forHeading:t,geometry:i,renderCoordsHelper:n}){return t?_e(e,i,n):Ve(e,i,{invert:!0})}function Mn(e,t){const i=Ee(wn,e),n=_e(Pn,e,t);return k(i,n)>0}const wn=P(),Pn=P();function Cn(e){return R(e)+_.offsetManipulator.linePaddingPx}function Ge(e){return R(e)+_.offsetManipulator.focusedLinePaddingPx}const H=xt.Custom1,X=P(),ve=P(),he=Oe(),Pt=new q;var D;function bn(e,t){return{enabled:t.effectiveFeatureEnabled,elevationAlignedStartPoint:e.elevationAlignedStartPoint,elevationAlignedEndPoint:e.elevationAlignedEndPoint,geometry:e.geometry}}function $n(e,t){if(ht(e))return D.Direct;if(!e.enabled)return null;const{geometry:i}=e;if(i==null||tt(i.directSegment.startRenderSpace,i.directSegment.endRenderSpace))return null;const{constraintThresholdPx:n}=_,{camera:s}=t.state,a=_e(f.get(),i,t.renderCoordsHelper),o=Ee(f.get(),i),r=se(f.get(),a,k(o,a)),l=at(f.get(),o,r),c=Se(l),p=Se(r),{startRenderSpace:m,endRenderSpace:h}=i.directSegment,S=Math.max(s.computeRenderPixelSizeAt(m)*n,s.computeRenderPixelSizeAt(h)*n)**2;return c<S?D.Vertical:p<S?D.Horizontal:null}function Tn(e,t,{constraint:i,view:n}){const{unconstrainedGeometry:s}=e;if(s==null)return;const{renderCoordsHelper:a,spatialReference:o}=n,{startRenderSpace:r,endRenderSpace:l}=s.directSegment,c=a.fromRenderCoords(r,new j,o),p=a.fromRenderCoords(l,new j,o);let m;m=t==="start"?{startPoint:c}:{endPoint:p},Ct(e,m,{constraint:i,elevationAlignedStartPoint:e.elevationAlignedStartPoint,elevationAlignedEndPoint:e.elevationAlignedEndPoint,unconstrainedGeometry:s,view:n})}function Ct(e,t,i){const{constraint:n,elevationAlignedStartPoint:s,elevationAlignedEndPoint:a,unconstrainedGeometry:o,view:r}=i,{dimension:l,previousConstraint:c,preConstraintProperties:p}=e;if(s==null||a==null)return;const m=()=>{"startPoint"in t?l.startPoint=t.startPoint:"endPoint"in t&&(l.endPoint=t.endPoint)};if(n==null)m(),c!=null&&p!=null&&(l.measureType=p.measureType,l.orientation=p.orientation);else switch(l.measureType=g.Direct,n){case D.Horizontal:if(n!==c&&(l.orientation=0),"startPoint"in t){const h=t.startPoint;h!=null&&(h.z=a.z),l.startPoint=h}else if("endPoint"in t){const h=t.endPoint;h!=null&&(h.z=s.z),l.endPoint=h}break;case D.Vertical:if(n!==c&&(l.orientation=yt(o,r)),"startPoint"in t){const h=t.startPoint;h!=null&&(h.x=a.x,h.y=a.y),l.startPoint=h}else if("endPoint"in t){const h=t.endPoint;h!=null&&(h.x=s.x,h.y=s.y),l.endPoint=h}break;case D.Direct:n!==c&&p!=null&&(l.orientation=p.orientation),m()}e.previousConstraint=n,e.unconstrainedGeometry=o}(function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.Direct=2]="Direct"})(D||(D={}));function On(e,t){const i=new Lt({enabled:!0,selfEnabled:!1,featureEnabled:!0,distance:t==null?void 0:t.distance,touchSensitivityMultiplier:(t==null?void 0:t.touchSensitivityMultiplier)??Et.touchSensitivityMultiplier});return{...v(()=>{var n,s;return((s=(n=e.map)==null?void 0:n.allLayers)==null?void 0:s.toArray())??[]},n=>{i.featureSources=new Ae(n.map(s=>new Vt({layer:s,enabled:!0})))},ue),options:i}}const re=new Map;function Dn(e){if(!re.has(e)){const n=On(e,{distance:10}),s=xn(e,n.options);re.set(e,{referenceCount:0,snappingManager:s,remove:()=>{n.remove(),s.destroy()}})}const t=re.get(e);t.referenceCount++;const i=xe(()=>An(e,t));return{snappingManager:t.snappingManager,...i}}function An(e,t){t.referenceCount--,t.referenceCount>0||It(()=>{t.referenceCount===0&&(t.remove(),re.delete(e))})}function xn(e,t){return new Gt({view:e,options:t,snappingEnginesFactory:(i,n)=>[new Ft({view:e,spatialReference:e.spatialReference,options:n})]})}let w=class extends Ut{constructor(e){super(e),this._stagedDimension=null,this._computationManipulators=new Map,this._computationHandles=new De,this._getSnappingContext=Mi(n=>new xi({elevationInfo:{mode:"absolute-height",offset:0},pointer:n,editGeometryOperations:new Oi(new Di("point",Ai(!0,!1,this.view.spatialReference))),visualizer:new wi}));const{view:t}=e;this._snappingManagerResult=Dn(t),this.addHandles(this._snappingManagerResult),this._unfocusedOffsetManipulatorMaterial=ye(),this._focusedOffsetManipulatorMaterial=ye(),this._thinOffsetManipulatorMaterial=ye(),this._thinOffsetManipulatorMaterial.setParameters({stipplePattern:ce(2)}),this._constraintSnappingIndicator=new G({view:t,attached:!0,width:1,color:U.toUnitRGBA(_.constraint.color),renderOccluded:O.OccludeAndTransparent,stipplePattern:ce(5)});const i=U.toUnitRGBA(_.disabledPointIndicator.color);this._stagedStartIndicator=new Pi({view:t,attached:!1,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:e.view.renderCoordsHelper.spatialReference,color:i,size:2*_.disabledPointIndicator.radius,outlineSize:0,renderOccluded:O.OccludeAndTransparent})}initialize(){var s;this._snappingOperation=new Ri({view:this.view});const{color:e,contrastColor:t}=_.orientationManipulator,i=!((s=this.view._stage)!=null&&s.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result);this._orientationManipulatorTexture=yi(this.view.toolViewManager.textures,{accentColor:e,contrastColor:t,preMultiplyAlpha:i}),this._orientationManipulatorMaterial=new Ti({transparent:!0,writeDepth:!1,textureId:this._orientationManipulatorTexture.texture.id,renderOccluded:O.Opaque});const{computations:n}=this.analysisViewData;for(const a of n)this._addComputation(a);this.addHandles([n.on("after-add",a=>this._addComputation(a.item)),n.on("after-remove",a=>this._removeComputation(a.item))]),this.addHandles([v(()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation}),({stagedPoint:a,stagedComputation:o})=>{if(o==null||a==null)return;const r=K(a,new j);this._applyPointUpdate(o,{endPoint:r})},be),v(()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}),(a,o)=>{const{stagedDimension:r,selectedComputation:l,firstGrabbedManipulator:c}=a;if(r===(o==null?void 0:o.stagedDimension)&&c===(o==null?void 0:o.firstGrabbedManipulator)){for(const p of[l,o==null?void 0:o.selectedComputation])if(p!=null){const m=this._computationManipulators.get(p);this._updateManipulators(p,m,a)}}else for(const[p,m]of this._computationManipulators)this._updateManipulators(p,m,a)},x),v(()=>this.analysis.style.lineSize,a=>{this._updateManipulatorStyle(a)},ue),v(()=>this.view.state.camera,()=>{this._stagedComputation!=null&&this._updateStagedDimensionOffset(this._stagedComputation)}),v(()=>qt(this._stagedComputation,a=>{const o=a.elevationAlignedStartPoint,r=P();return o!=null&&this.view.renderCoordsHelper.toRenderCoords(o,r)?r:null}),a=>{a!=null?(this._stagedStartIndicator.vertices=[a],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1})]),this.addHandles(this._constraintHandles),this.addHandles(this._snappingIndicatorHandles),Bt(this,()=>{const a=this._activeComputation,o=this._stagedComputation;if(a==null||o!=null){const r=this.view.inputManager.latestPointerType??"mouse",l=this._getSnappingContext(r);this.updatingHandles.addPromise(je(this._snappingOperation.resnap(this._snappingManager,l)))}if(a!=null){const{start:r,end:l}=this._computationManipulators.get(a);if(r.grabbing||l.grabbing){const c=r.grabbing?"start":"end",p=this._computeConstraint(a);Tn(a,c,{constraint:p,view:this.view})}}})}destroy(){this._snappingOperation=ee(this._snappingOperation),this._computationHandles.destroy(),this._constraintSnappingIndicator.destroy(),this._stagedStartIndicator.destroy(),this._orientationManipulatorMaterial.dispose(),this._orientationManipulatorTexture.release()}get updating(){return this.updatingHandles.updating||this._snappingManager.updating}get firstGrabbedManipulator(){return this.parentTool.firstGrabbedManipulator}get hasGrabbedManipulators(){return this.parentTool.hasGrabbedManipulators}get snappingOptions(){return this._snappingManager.options}get _snappingManager(){return this._snappingManagerResult.snappingManager}get _activeComputation(){if(this._stagedComputation!=null)return this._stagedComputation;const{selectedComputation:e}=this.analysisViewData;return this.hasGrabbedManipulators&&e!=null?e:null}get _stagedComputation(){const e=this._stagedDimension,t=this.analysisViewData.computations.at(-1);return e==null||t==null||t.dimension!==e?null:t}get _constraintHandles(){return[Re(()=>this.analysisViewData.selectedComputation,e=>{e.previousConstraint=this._computeConstraint(e)},{...x,equals:$e}),v(()=>{const e=this._activeComputation;if(e==null)return null;const{measureType:t,orientation:i}=e.dimension;return{measureType:t,orientation:i,computation:e}},(e,t)=>{if(e!=null&&t==null){const{measureType:i,orientation:n,computation:s}=e;switch(s.previousConstraint){case D.Horizontal:s.preConstraintProperties={measureType:g.Horizontal,orientation:0};break;case D.Vertical:s.preConstraintProperties={measureType:g.Vertical,orientation:0};break;case D.Direct:s.preConstraintProperties={measureType:g.Direct,orientation:n};break;default:s.preConstraintProperties={measureType:i,orientation:n}}}e==null&&t!=null&&(t.computation.preConstraintProperties=null)},be)]}get _snappingIndicatorHandles(){const e="snapping-indicator-event-handles";return[v(()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation}),({stagedComputation:t,activeComputation:i})=>{const n=this._constraintSnappingIndicator;if(this.removeHandles(e),i!=null)if(i===t)n.attached=!0;else{const{start:s,end:a}=this._computationManipulators.get(i),o=()=>{n.attached=s.grabbing||a.grabbing};o(),this.addHandles([s.events.on("grab-changed",o),a.events.on("grab-changed",o)],e)}else n.attached=!1}),v(()=>{const t=this._activeComputation;return t!=null?{geometry:t.geometry,constraint:t.previousConstraint}:{}},({geometry:t,constraint:i})=>{const n=this._constraintSnappingIndicator;t!=null&&i!=null&&i!==D.Direct?(n.visible=!0,n.setGeometryFromSegment(t.directSegment)):n.visible=!1})]}removeStaged(){return this._stagedDimension!=null&&(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0)}onDeactivate(){this.removeStaged(),this._resetSnappingState()}onClick(e){const{_stagedDimension:t}=this;if(t==null){const i=this._onUnstagedClick(e);return this.analysis.dimensions.add(i),null}return this._onStagedClick(e),t}onPointerMove({mapPoint:e,pointerType:t}){if(t==="touch")return;const i=this._getSnappingContext(t);this.updatingHandles.addPromise(je(this._snappingOperation.snap({point:e},this._snappingManager,i)))}onManipulatorSelectionChanged(){this.analysisViewData.selectedComputation!=null&&(this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected||(this.analysisViewData.selectedDimension=null))}_onUnstagedClick({mapPoint:e,pointerType:t}){let i=e;if(t==="mouse"){const s=this._getSnappingContext(t);i=this._snappingManager.update({point:e,context:s})}const n=new ri({startPoint:K(i,new j),endPoint:null,measureType:g.Horizontal});return this._stagedDimension=n,this._resetSnappingState(),n}_onStagedClick({mapPoint:e,pointerType:t}){const i=this._stagedComputation;if(i==null)return;let n=e;if(t==="mouse"){const a=this._getSnappingContext(t);n=this._snappingManager.update({point:e,context:a})}const s=K(n,new j);this._applyPointUpdate(i,{endPoint:s}),this._stagedDimension=null,this._resetSnappingState()}_resetSnappingState(){this._snappingManager.doneSnapping(),this._snappingOperation.abort(),this._snappingOperation.stagedPoint=null}_addComputation(e){if(this._computationManipulators.has(e))return;const t=this._setupPointManipulator(e,{isStart:!0}),i=this._setupPointManipulator(e,{isStart:!1}),n=this._setupOffsetManipulator(e),s=this._setupHeadingManipulator(e),a=this._setupRotationManipulator(e),o=this._setupMeasureTypeManipulator(e,g.Direct),r=this._setupMeasureTypeManipulator(e,g.Horizontal),l=this._setupMeasureTypeManipulator(e,g.Vertical),c=new sn({start:t,end:i,offset:n,heading:s,rotation:a,direct:o,horizontal:r,vertical:l});this._setupComputationToManipulatorsSync(e,c),this._computationManipulators.set(e,c),this.manipulators.addMany(c.values())}_removeComputation(e){const t=this._computationManipulators.get(e);if(t!=null){this._computationHandles.remove(e),this._computationManipulators.delete(e);for(const i of t.values())this.manipulators.remove(i)}}_setupComputationToManipulatorsSync(e,t){this._computationHandles.add([v(()=>e.geometry,()=>this._updateManipulators(e,t),{...x,equals:$e})],e)}_setupPointManipulator(e,t){const{view:i}=this,{dimension:n}=e,s=an(i,{metadata:n}),a=ln(s,{isStart:t.isStart,createSnappingPipelineStep:o=>zi({snappingContext:this._getSnappingContext(o),snappingManager:this._snappingManager,updatingHandles:this.updatingHandles}),dimension:n,onUpdate:o=>this._applyPointUpdate(e,o),view:i});return this._computationHandles.add(a,e),s}_setupOffsetManipulator(e){const{view:t}=this,i=on(t,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:e.dimension}),n=dn(i,{computation:e,view:t});return this._computationHandles.add(n,e),i}_setupHeadingManipulator(e){const{view:t}=this,i=Ke(t,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:e.dimension}),n=un(i,{computation:e,view:t});return this._computationHandles.add(n,e),i}_setupRotationManipulator(e){const{view:t}=this,i=Ke(t,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:e.dimension}),n=cn(i,{computation:e,view:t});return this._computationHandles.add(n,e),i}_setupMeasureTypeManipulator(e,t){const{view:i}=this,n=rn(i,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:e.dimension}),s=hn(n,{computation:e,manipulatorMeasureType:t,view:i});return this._computationHandles.add(s,e),n}_updateManipulators(e,t,i={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const{stagedDimension:n,selectedComputation:s,firstGrabbedManipulator:a}=i,{start:o,end:r,offset:l,heading:c,rotation:p}=t,m=s===e,h=ie(e),{dimension:S}=e;for(const y of t.values()){const L=h&&n==null&&(a==null||y===a);y===l?(y.available=L,y.selected=m):y.available=L&&m}if(!h)return;this._computeConstraint(e)!=null?t.forEachMeasureTypeManipulator(y=>y.available=!1):t.manipulatorForMeasureType(S.measureType).available=!1;for(const y of[c,p])S.measureType===g.Direct&&S.offset!==0||(y.available=!1);Le(e)?p.available=!1:c.available=!1;const{geometry:M}=e;o.renderLocation=M.directSegment.startRenderSpace,r.renderLocation=M.directSegment.endRenderSpace;const{renderCoordsHelper:b}=this.view;fn(l,M,b),c.available&&gn(c,e,b),p.available&&_n(p,e,b),t.forEachMeasureTypeManipulator((y,L)=>{y.available&&Sn(y,e,L,b)})}_updateManipulatorStyle(e){const t=Cn(e),i=Ge(e),n={lineSizePt:e,material:this._orientationManipulatorMaterial};for(const{offset:s,heading:a,rotation:o}of this._computationManipulators.values())s.radius=i/2,Ze(a,n),Ze(o,n);this._unfocusedOffsetManipulatorMaterial.setParameters({width:t}),this._focusedOffsetManipulatorMaterial.setParameters({width:i})}_applyPointUpdate(e,t){const{view:i}=this,n=pe(e);"startPoint"in t&&(n.elevationAlignedStartPoint=t.startPoint),"endPoint"in t&&(n.elevationAlignedEndPoint=t.endPoint);const s=me(n,i.renderCoordsHelper);if(s==null)return;const a=this._computeConstraint({...n,geometry:s});Ct(e,t,{...n,constraint:a,unconstrainedGeometry:s,view:i}),e===this._stagedComputation&&this._updateStagedDimensionOffset(e)}_updateStagedDimensionOffset(e){if(e.geometry==null)return;e.geometry.directSegment.eval(.5,Qe);const t=this.view.state.camera.computeRenderPixelSizeAt(Qe);e.dimension.offset=_.initialOffsetPx*t}_computeConstraint(e){return $n(bn(e,this._snappingManager.options),this.view)}get testInfo(){const e=t=>this.analysisViewData.computations.find(i=>i.dimension===t);return{disableManipulatorPartialOcclusion:()=>{this._stagedStartIndicator.renderOccluded=O.Occlude,this.manipulators.forEach(({manipulator:t})=>{for(const{geometry:i}of t.renderObjects)i.material.setParameters({renderOccluded:O.Occlude})})},getManipulatorsForDimension:t=>this._computationManipulators.get(e(t)),getComputationForDimension:t=>e(t),getConstraintForDimension:t=>{const i=e(t);return i!=null?this._computeConstraint(i):null},stagedDimension:this._stagedDimension,stagedStartIndicator:this._stagedStartIndicator,constraintSnappingIndicator:this._constraintSnappingIndicator,snappingManager:this._snappingManager}}};function ye(){const{color:e}=_.offsetManipulator;return new J({color:U.toUnitRGBA(e),width:1,renderOccluded:O.OccludeAndTransparent,writeDepth:!1,hasPolygonOffset:!0})}d([u({constructOnly:!0})],w.prototype,"analysis",void 0),d([u({constructOnly:!0})],w.prototype,"analysisViewData",void 0),d([u({constructOnly:!0})],w.prototype,"manipulators",void 0),d([u({constructOnly:!0})],w.prototype,"parentTool",void 0),d([u({constructOnly:!0,nonNullable:!0})],w.prototype,"view",void 0),d([u({readOnly:!0})],w.prototype,"updating",null),d([u()],w.prototype,"firstGrabbedManipulator",null),d([u()],w.prototype,"hasGrabbedManipulators",null),d([u()],w.prototype,"snappingOptions",null),d([u()],w.prototype,"_stagedDimension",void 0),d([u()],w.prototype,"_activeComputation",null),d([u()],w.prototype,"_stagedComputation",null),w=d([V("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],w);const Qe=P();var B;(function(e){e.Ready="ready",e.Creating="creating",e.Created="created"})(B||(B={}));let $=class extends Hi{constructor(e){super(e),this.automaticManipulatorSelection=!1,this.removeIncompleteOnCancel=!1,this._pointerMoveTimerMs=_.pointerMoveTimeoutMs,this._prevPointerMoveTimeout=null}initialize(){this._intersector=jt(this.view.state.viewingMode),this._intersector.options.store=Nt.MIN,this._lengthDimensionSubTool=new w({analysis:this.analysis,analysisViewData:this.analysisViewData,manipulators:this.manipulators,parentTool:this,view:this.view}),this.addHandles([Wt(this._lengthDimensionSubTool),xe(()=>this._clearPointerMoveTimeout()),v(()=>this.state,e=>{e===B.Created&&this.finishToolCreation()},x),Re(()=>this.firstGrabbedManipulator,e=>{this.selectedDimension=e.metadata},x),v(()=>this.selectedDimension,()=>this._resetPointerMoveTimeout(),x)])}get state(){return this.analysis.dimensions.some(e=>e.type==="length")?this._activeSubTool!=null?B.Creating:B.Created:B.Ready}get updating(){return this._lengthDimensionSubTool.updating}get cursor(){return this.active?"crosshair":null}get selectedDimension(){return this.analysisViewData.selectedDimension}set selectedDimension(e){this.analysisViewData.selectedDimension=e}onInputEvent(e){switch(e.type){case"immediate-click":this._clickHandler(e);break;case"immediate-double-click":this._doubleClickHandler(e);break;case"pointer-move":this._pointerMoveHandler(e);break;case"key-down":if(Ne.cancel===e.key){if(this._activeSubTool!=null&&this._activeSubTool.removeStaged())return void e.stopPropagation();this.active||(this.selectedDimension=null)}else Ne.delete.includes(e.key)&&this._deleteKeyHandler()}}onActivate(){this._activeSubTool=this._lengthDimensionSubTool}onDeactivate(){this._activeSubTool!=null&&(this._activeSubTool.onDeactivate(),this._activeSubTool=null)}onShow(){this._resetPointerMoveTimeout()}onManipulatorSelectionChanged(){this._lengthDimensionSubTool.onManipulatorSelectionChanged()}onHide(){this.selectedDimension=null}_clickHandler(e){if(this.hasFocusedManipulators)return void e.stopPropagation();if(this._activeSubTool==null)return;const t=this._intersectScreen(e);t!=null&&(this.selectedDimension=this._activeSubTool.onClick({mapPoint:t,pointerType:e.pointerType}),e.stopPropagation())}_doubleClickHandler(e){this.active&&(this.view.activeTool=null,e.stopPropagation())}_pointerMoveHandler(e){if(this._resetPointerMoveTimeout(),this._activeSubTool==null||this.hasFocusedManipulators)return;const t=this._intersectScreen(e);t!=null&&this._activeSubTool.onPointerMove({mapPoint:t,pointerType:e.pointerType})}_deleteKeyHandler(){this._activeSubTool!=null&&this._activeSubTool.removeStaged(),this._removeSelected()}_intersectScreen(e){const t=Jt(e);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector);const i=this._intersector.results.min,n=f.get();return i.getIntersectionPoint(n)?this.view.renderCoordsHelper.fromRenderCoords(n,this.view.spatialReference):null}_removeSelected(){this.selectedDimension!=null&&(this.analysis.dimensions.remove(this.selectedDimension),this.selectedDimension=null)}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=Yt(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.manipulators.forEach(e=>{e.manipulator.state|=H}),this._prevPointerMoveTimeout=Kt.setTimeout(()=>{this.manipulators.forEach(e=>{e.manipulator.state&=~H})},this._pointerMoveTimerMs)}get testInfo(){return{...this._lengthDimensionSubTool.testInfo,setManipulatorAutoHideDelay:e=>{this._pointerMoveTimerMs=e,this._resetPointerMoveTimeout()}}}};d([u({constructOnly:!0})],$.prototype,"view",void 0),d([u({constructOnly:!0})],$.prototype,"analysis",void 0),d([u({readOnly:!0})],$.prototype,"state",null),d([u({readOnly:!0})],$.prototype,"updating",null),d([u({readOnly:!0})],$.prototype,"cursor",null),d([u({constructOnly:!0})],$.prototype,"analysisViewData",void 0),d([u()],$.prototype,"selectedDimension",null),d([u()],$.prototype,"automaticManipulatorSelection",void 0),d([u()],$.prototype,"_activeSubTool",void 0),d([u()],$.prototype,"_lengthDimensionSubTool",void 0),$=d([V("esri.views.3d.analysis.Dimension.DimensionTool")],$);class Rn extends Ci{constructor(t,i){super(t),this._hasExternalMaterial=!1,this._renderOccluded=O.OccludeAndTransparent,this._width=1,this._color=Zt(1,0,1,1),this._placement="end",this._markerPrimitive="arrow",this._material=i,this._hasExternalMaterial=i!=null,this.applyProps(t)}setGeometryFromSegment(t,i){const n=t.endRenderSpace;this.transform=Qt(zn,n),this._normal=i;const{points:s}=t.createRenderGeometry(n,this.view.renderCoordsHelper);this.geometry=[s]}get renderOccluded(){return this._material!=null?this._material.parameters.renderOccluded:this._renderOccluded}set renderOccluded(t){this._renderOccluded=t,this._material!=null&&this._material.setParameters({renderOccluded:t})}get geometry(){return this._geometry}set geometry(t){this._geometry=t,this.recreateGeometry()}get normal(){return this._normal}set normal(t){this._normal=t,this.recreateGeometry()}get width(){return this._material!=null?this._material.parameters.width:this._width}set width(t){this._width=t,this._material!=null&&this._material.setParameters({width:t})}get color(){return this._material!=null?this._material.parameters.color:this._color}set color(t){this._color=Xt(t),this._material!=null&&this._material.setParameters({color:this._color})}get placement(){return this._material!=null?this._material.parameters.placement:this._placement}set placement(t){this._placement=t,this._material!=null&&this._material.setParameters({placement:this._placement})}get markerPrimitive(){var t;return((t=this._material)==null?void 0:t.parameters.markerPrimitive)??this._markerPrimitive}set markerPrimitive(t){this._markerPrimitive=t,this._material!=null&&this._material.setParameters({markerPrimitive:t})}createExternalResources(){this._hasExternalMaterial||(this._material=new ot({width:this._width,color:this._color,placement:this._placement,renderOccluded:this._renderOccluded,markerPrimitive:this._markerPrimitive}))}destroyExternalResources(){this._hasExternalMaterial||(this._material=null)}createGeometries(t){for(const i of ei(this.geometry,this.normal)){const n=ti(this._material,i);t.addGeometry(n)}}forEachExternalMaterial(t){this._hasExternalMaterial||t(this._material)}}const zn=Oe();let Hn=class{set visible(t){for(const i of this._visualElements.values())i.attached=t}constructor(t){this.destroyed=!1,this._handles=new De,this._messages=null,this._labelSegment=new q;const{analysis:i,computation:n,view:s,messages:a}=t;this.analysis=i,this.computation=n,this.view=s,this._messages=a;const o=t.visible,r={view:s,attached:o},{fontSize:l,textColor:c,textBackgroundColor:p}=i.style;this._visualElements=new Gn({marker:new Rn(r,t.markerMaterial),dimension:new G(r,t.dimensionLineMaterial),startOffset:new G(r,t.offsetLineMaterial),endOffset:new G(r,t.offsetLineMaterial),dimensionSmall:new G(r,t.smallDimensionLineMaterial),startOffsetSmall:new G(r,t.smallOffsetLineMaterial),endOffsetSmall:new G(r,t.smallOffsetLineMaterial),label:new ui({view:s,attached:o,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:R(l),textColor:c.clone(),backgroundColor:p.clone()})}),this._handles.add([v(()=>n.geometry,m=>{this.updateCameraDependentElements(s.state.camera,m,i.style),n.geometry!=null&&this._updateLines(n.geometry)},{...ue,equals:$e}),v(()=>n.length,m=>this._updateLabelContent(m),ue)])}destroy(){this.destroyed=!0,this._handles=ee(this._handles);for(const t of this._visualElements.values())t.destroy()}get testInfo(){return{dimensionVisualElement:this._visualElements.dimension,label:this._visualElements.label}}_updateLines(t){const i=Ye(Ln,te.Start,t.directSegment,t.dimensionSegment),n=Ye(En,te.End,t.directSegment,t.dimensionSegment),s=this._visualElements;s.marker.setGeometryFromSegment(t.dimensionSegment,t.primaryOffsetAxis),s.dimension.setGeometryFromSegment(t.dimensionSegment),s.startOffset.setGeometryFromSegment(i),s.endOffset.setGeometryFromSegment(n),s.dimensionSmall.setGeometryFromSegment(t.dimensionSegment),s.startOffsetSmall.setGeometryFromSegment(i),s.endOffsetSmall.setGeometryFromSegment(n)}updateCameraDependentElements(t,i,n){const s=this._visualElements;if(i==null){for(const b of s.values())b.visible=!1;return}const a=t.computeScreenPixelSizeAt(i.dimensionSegment.eval(.5,Vn)),o=Ni(i,a),r=o<(R(n.lineSize)*_.smallScreenLengthLineSizeFactor)**2,l=!r;s.marker.visible=l,s.dimension.visible=l,s.startOffset.visible=l,s.endOffset.visible=l,s.dimensionSmall.visible=r,s.startOffsetSmall.visible=r,s.endOffsetSmall.visible=r;const c=R(n.fontSize)*_.labels.minScreenLengthFontSizeFactor,{label:p}=s;if(p.visible=o>=c**2,!p.visible)return;const{dimensionSegment:m,primaryOffsetAxis:h}=i,{offset:S}=this.computation.dimension,M=(Math.sign(S)>=0?1:-1)*kn(n)*a;Gi(this._labelSegment,m,h,M),p.updateLabelPosition()}updateLabelStyle(t){const{label:i}=this._visualElements;i.fontSize=R(t.fontSize),i.textColor=t.textColor,i.backgroundColor=t.textBackgroundColor}updateUnitsMessages(t){this._messages=t;const{length:i}=this.computation;this._updateLabelContent(i)}_updateLabelContent(t){const{label:i}=this._visualElements;t!=null&&this._messages!=null?i.text=di(this._messages,t,t.unit):i.text=""}};function kn(e){return 1.5*R(e.fontSize)+_.labels.marginPx+R(e.lineSize/2)}const Ln=new q,En=new q,Vn=P();class Gn{constructor(t){this.marker=t.marker,this.dimension=t.dimension,this.startOffset=t.startOffset,this.endOffset=t.endOffset,this.dimensionSmall=t.dimensionSmall,this.startOffsetSmall=t.startOffsetSmall,this.endOffsetSmall=t.endOffsetSmall,this.label=t.label}values(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]}}let E=class extends ne{get analysis(){return this.analysisViewData.analysis}get visible(){return this.analysisViewData.visible}constructor(t){super(t),this.loadingMessages=!1,this._messages=null,this._dimensionVisualizations=new Map,this._markerMaterial=new ot({width:1,anchor:ii.Tip,color:W,placement:"begin-end",worldSpace:!0,hideOnShortSegments:!0,hasTip:!0,renderOccluded:O.OccludeAndTransparent,markerPrimitive:"triangle"}),this._dimensionLineMaterial=new J({width:1,color:W,renderOccluded:O.OccludeAndTransparent,markerParameters:this._markerMaterial.parameters}),this._offsetLineMaterial=new J({width:1,color:W,renderOccluded:O.OccludeAndTransparent,stipplePattern:ce(5),stippleScaleWithLineWidth:!0}),this._smallDimensionLineMaterial=new J({width:1,color:W,renderOccluded:O.OccludeAndTransparent}),this._smallOffsetLineMaterial=new J({width:1,color:W,renderOccluded:O.OccludeAndTransparent,stipplePattern:ce(5),stippleScaleWithLineWidth:!0})}initialize(){for(const i of this._lineMaterials())this.view._stage.add(i),this.addHandles(xe(()=>{var n;(n=this.view._stage)==null||n.remove(i),i.dispose()}));const{computations:t}=this.analysisViewData;for(const i of t)this._addComputation(i);this.addHandles([t.on("change",({added:i,removed:n})=>{for(const s of n)this._removeComputation(s);for(const s of i)this._addComputation(s)}),v(()=>U.toUnitRGBA(this.analysis.style.color),i=>{for(const n of this._lineMaterials())n.setParameters({color:i})},x),v(()=>this.analysis.style.lineSize,i=>{const n=R(i);this._markerMaterial.setParameters({width:n*_.markers.lineSizeFraction}),this._dimensionLineMaterial.setParameters({width:n,markerParameters:this._markerMaterial.parameters});const s=Math.max(n*_.offsetLine.lineSizeFraction,1);this._offsetLineMaterial.setParameters({width:s})},x),v(()=>({camera:this.view.state.camera,style:Fn(this.analysis)}),({camera:i,style:n})=>{for(const[s,a]of this._dimensionVisualizations)a.updateCameraDependentElements(i,s.geometry,n),a.updateLabelStyle(n)}),v(()=>this.visible,i=>{for(const n of this._dimensionVisualizations.values())n.visible=i})]),this.addHandles([ni(()=>this._updateMessageBundle()),Re(()=>!this.loadingMessages,()=>{for(const i of this._dimensionVisualizations.values())i.updateUnitsMessages(this._messages)},be)]),this._updateMessageBundle()}destroy(){this._dimensionVisualizations.forEach(t=>{t.destroy()}),this._dimensionVisualizations.clear()}get testInfo(){return{visualizations:Array.from(this._dimensionVisualizations.values()),disablePartialOcclusion:()=>{for(const t of this._lineMaterials())t.setParameters({renderOccluded:O.Occlude})}}}_addComputation(t){this._dimensionVisualizations.has(t)||this._dimensionVisualizations.set(t,new Hn({analysis:this.analysis,computation:t,view:this.view,visible:this.visible,markerMaterial:this._markerMaterial,dimensionLineMaterial:this._dimensionLineMaterial,offsetLineMaterial:this._offsetLineMaterial,smallDimensionLineMaterial:this._smallDimensionLineMaterial,smallOffsetLineMaterial:this._smallOffsetLineMaterial,messages:this._messages}))}_removeComputation(t){const i=this._dimensionVisualizations.get(t);i!=null&&(i.destroy(),this._dimensionVisualizations.delete(t))}_lineMaterials(){return[this._markerMaterial,this._dimensionLineMaterial,this._offsetLineMaterial,this._smallDimensionLineMaterial,this._smallOffsetLineMaterial]}async _updateMessageBundle(){this.loadingMessages=!0;try{this._messages=await si("esri/core/t9n/Units")}finally{this.loadingMessages=!1}}};function Fn(e){const{fontSize:t,lineSize:i,textColor:n,textBackgroundColor:s}=e.style;return{fontSize:t,lineSize:i,textBackgroundColor:s.clone(),textColor:n.clone()}}d([u({constructOnly:!0})],E.prototype,"analysisViewData",void 0),d([u({constructOnly:!0,nonNullable:!0})],E.prototype,"view",void 0),d([u()],E.prototype,"analysis",null),d([u()],E.prototype,"visible",null),d([u()],E.prototype,"loadingMessages",void 0),E=d([V("esri.views.3d.analysis.Dimension.DimensionVisualization")],E);let Y=class extends ne{constructor(e){super(e),this.dimension=null,this.length=null}};d([u({constructOnly:!0,nonNullable:!0})],Y.prototype,"dimension",void 0),d([u()],Y.prototype,"length",void 0),Y=d([V("esri.views.3d.analysis.LengthDimensionResult")],Y);const In=Y;let T=class extends ne{constructor(e){super(e),this.geometry=null,this.unconstrainedGeometry=null,this.elevationAlignedStartPoint=null,this.elevationAlignedEndPoint=null}normalizeCtorArgs(e){const{dimension:t,...i}=e;return{result:new In({dimension:t}),...i}}initialize(){this.addHandles([v(()=>this.dimension.startPoint,e=>this.elevationAlignedStartPoint=this.projectAndAlignPoint(e),x),v(()=>this.dimension.endPoint,e=>this.elevationAlignedEndPoint=this.projectAndAlignPoint(e),x)])}get dimension(){return this.result.dimension}get length(){return this.result.length}};d([u({constructOnly:!0,nonNullable:!0})],T.prototype,"result",void 0),d([u({constructOnly:!0,nonNullable:!0})],T.prototype,"projectAndAlignPoint",void 0),d([u()],T.prototype,"dimension",null),d([u()],T.prototype,"length",null),d([u()],T.prototype,"geometry",void 0),d([u()],T.prototype,"unconstrainedGeometry",void 0),d([u()],T.prototype,"elevationAlignedStartPoint",void 0),d([u()],T.prototype,"elevationAlignedEndPoint",void 0),d([u()],T.prototype,"preConstraintProperties",void 0),d([u()],T.prototype,"previousConstraint",void 0),T=d([V("esri.views.3d.analysis.LengthDimensionComputation")],T);const Un=e=>{let t=class extends e{constructor(...i){super(...i),this.analysis=null,this.tool=null,this.selectedDimension=null,this.interactive=!1,this.visible=null}get results(){return new Ae}createLengthDimensions(i){throw new Error("Method not implemented.")}};return d([u({constructOnly:!0})],t.prototype,"view",void 0),d([u({constructOnly:!0,nonNullable:!0})],t.prototype,"analysis",void 0),d([u()],t.prototype,"tool",void 0),d([u({readOnly:!0})],t.prototype,"results",null),d([u()],t.prototype,"selectedDimension",void 0),d([u()],t.prototype,"interactive",void 0),d([u()],t.prototype,"visible",void 0),t=d([V("esri.views.analysis.DimensionAnalysisView")],t),t};let C=class extends Un(ai(ne)){constructor(e){super(e),this.type="dimension-view-3d",this.tool=null,this.computations=new Ae,this.selectedDimension=null,this._dimensionsToComputations=new Map,this._placementTask=null,this._projectAndAlignPoint=null}initialize(){this._projectAndAlignPoint=e=>{if(e==null)return null;const{spatialReference:t,elevationProvider:i}=this.view,n=bi(e,t,i);return n==null&&$i(this.analysis,e.spatialReference,et.getLogger(this)),n},this.addHandles([ki(this,$),We(()=>this.analysis.dimensions,"after-add",e=>this._onDimensionAdd(e.item),{onListenerAdd:e=>{for(const t of e)this._onDimensionAdd(t)},onListenerRemove:()=>{this._onDimensionsClear()}}),We(()=>this.analysis.dimensions,"after-remove",e=>this._onDimensionRemove(e.item))]),this._analysisVisualization=new E({analysisViewData:this,view:this.view}),this._analysisController=new F({analysisViewData:this,view:this.view})}destroy(){this._placementTask=Je(this._placementTask),this._analysisVisualization=ee(this._analysisVisualization),Li(this)}get updating(){var e;return((e=this._analysisVisualization)==null?void 0:e.loadingMessages)??!1}get results(){return this.analysis.dimensions.map(e=>this._dimensionsToComputations.get(e).result)}get selectedComputation(){const{selectedDimension:e}=this;return e==null?null:this._dimensionsToComputations.get(e)}get testInfo(){return{visualization:this._analysisVisualization,controller:this._analysisController}}async createLengthDimensions(e){return this.selectedDimension=null,this._placementTask=Je(this._placementTask),this._placementTask=Ei(this,e),this._placementTask.promise}_onDimensionAdd(e){const{computations:t,_dimensionsToComputations:i}=this;if(i.has(e))return;const n=new T({dimension:e,projectAndAlignPoint:this._projectAndAlignPoint});t.add(n),i.set(e,n)}_onDimensionRemove(e){const{computations:t,_dimensionsToComputations:i}=this,n=t.findIndex(a=>a.dimension===e),s=t.at(n);s.dimension===this.selectedDimension&&(this.selectedDimension=null),t.removeAt(n),i.delete(e),ee(s)}_onDimensionsClear(){this.computations.drain(e=>e.destroy()),this._dimensionsToComputations.clear()}};d([u({readOnly:!0})],C.prototype,"type",void 0),d([u()],C.prototype,"tool",void 0),d([u()],C.prototype,"updating",null),d([u({readOnly:!0})],C.prototype,"results",null),d([u({readOnly:!0})],C.prototype,"computations",void 0),d([u()],C.prototype,"selectedDimension",void 0),d([u()],C.prototype,"selectedComputation",null),d([u()],C.prototype,"_analysisVisualization",void 0),d([u()],C.prototype,"_analysisController",void 0),d([u()],C.prototype,"_dimensionsToComputations",void 0),d([u()],C.prototype,"_placementTask",void 0),C=d([V("esri.views.3d.analysis.DimensionAnalysisView3D")],C);const bs=C;export{bs as default};
